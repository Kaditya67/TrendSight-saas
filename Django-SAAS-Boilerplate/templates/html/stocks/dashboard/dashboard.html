{% extends "stocks/dashboard/base.html" %}

{% block title %} Stocks {% endblock %}

{% block content %}
<style>
    /* Custom scrollbar styles */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px; /* For horizontal scrollbars */
    }

    ::-webkit-scrollbar-thumb {
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 10px;
        border: 2px solid transparent; /* Adds a small border to the thumb for contrast */
        background-clip: content-box;
        transition: background-color 0.3s ease;
    }

    ::-webkit-scrollbar-thumb:hover {
        background-color: rgba(0, 0, 0, 0.4); /* Darker color on hover */
    }

    ::-webkit-scrollbar-track {
        background-color: rgba(0, 0, 0, 0.1);
        border-radius: 10px;
    }

    /* For smooth scrolling effect */
    html {
        scroll-behavior: smooth;
    }
</style>

<div class="container mx-auto my-8">
    <!-- Header Section -->
    <div class="text-center mb-12">
        <h1 class="text-4xl font-bold text-gray-700">Nifty 50 Dashboard</h1>
        <p class="text-lg text-gray-500">Track key EMA trends and broader market insights</p>
    </div> 
    
    <!-- EMA Trend Analysis (Scrollable) -->
    <div class="mb-12">
        <h5 class="text-2xl font-bold text-gray-800 mb-4">
            Nifty 50 EMA Trends <span class="text-sm font-medium text-gray-500">(in days)</span>
        </h5>
        <div class="flex overflow-x-auto space-x-4 px-2 py-4 rounded-lg shadow-inner">
            {% for period, days in ema_trends.items %}
            <div class="card border border-gray-300 shadow-md rounded-lg p-4 text-left hover:shadow-xl hover:bg-blue-100 transition-all min-w-[150px] font-bold bg-gradient-to-r from-blue-50 to-white">
                <div class="flex items-center justify-between mb-2">
                    <p class="text-sm text-gray-600">{{ period|title }} EMA</p>
                </div>
                <span class="{% if days > 0 %}text-green-600{% else %}text-red-600{% endif %} text-sm">{{ days }} days</span>
            </div>
            {% endfor %}
        </div>
    </div>
    

    <style>
        .chartWrapper {
            width: 100%; /* Ensure the wrapper takes full width */
            overflow-x: auto; /* Enable horizontal scrolling */
            display: flex; /* Align the chart correctly */
        }
    
        .chartAreaWrapper {
            flex-shrink: 0; /* Prevent shrinking of the chart */
        }
    
        #sectorChart {
            height: 400px; /* Adjust height for better visibility */
        }
    </style>
    
    <!-- Graph Section -->
    <div class="mb-12">
        <h5 class="text-2xl font-bold text-gray-800 mb-4">Day Counts by Sector</h5>
        <!-- Scrollable container for the chart -->
        <div class="chartWrapper">
            <!-- Canvas will stretch to accommodate more sectors, and it's scrollable horizontally -->
            <div class="chartAreaWrapper">
                <canvas id="sectorChart"></canvas>
            </div>
        </div>
    </div>
    
<!-- Chart Section -->
<div class="chartWrapper">
    <div class="chartAreaWrapper">
        <canvas id="sectorChart"></canvas>
    </div>
</div>

<!-- Include Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Parse the dynamically passed sector data (in JSON format)
    const sectorData = JSON.parse('{{ sector_data_json|escapejs }}');

    const chartData = {
        labels: sectorData.map(item => item.name),  // Extract sector names
        datasets: [
            {
                label: 'Days',
                backgroundColor: function(context) {
                    const value = context.raw;
                    return value > 0 ? 'rgba(34, 197, 94, 0.7)' : 'rgba(239, 68, 68, 0.7)';
                },
                borderColor: function(context) {
                    const value = context.raw;
                    return value > 0 ? 'rgba(34, 197, 94, 1)' : 'rgba(239, 68, 68, 1)';
                },
                borderWidth: 1,
                data: sectorData.map(item => item.days),  // Extract the days data
            },
        ],
    };

    // Dynamically calculate the width based on number of sectors
    const sectorCount = chartData.labels.length;
    const widthPerSector = 110; // Width per sector in pixels
    const chartWidth = sectorCount * widthPerSector;

    // Chart configuration
    const config = {
        type: 'bar',
        data: chartData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false,
                },
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Sectors',
                        font: {
                            size: 14,
                            weight: 'bold',
                        },
                    },
                    ticks: {
                        font: {
                            size: 12,
                        },
                        autoSkip: true,
                        maxRotation: 45,
                    },
                    barPercentage: 0.6,
                    categoryPercentage: 0.8,
                    maxBarThickness: 50,
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Days',
                        font: {
                            size: 14,
                            weight: 'bold',
                        },
                    },
                    ticks: {
                        font: {
                            size: 12,
                        },
                    },
                },
            },
        },
    };

    // Render chart
    const ctx = document.getElementById('sectorChart').getContext('2d');
    new Chart(ctx, config);

    // Dynamically set the width of the chartAreaWrapper
    document.querySelector('.chartAreaWrapper').style.width = `${chartWidth}px`;
</script> 


    <!-- Broader Market Trend Table (Scrollable) -->
    <div class="mb-6">
        <label for="search" class="sr-only">Search</label>
        <div class="relative max-w-xs">
            <input type="text" id="search" placeholder="Search by index..." class="block w-full p-3 pl-10 pr-4 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="h-5 w-5">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 18a8 8 0 100-16 8 8 0 000 16zM21 21l-4.35-4.35" />
                </svg>
            </span>
        </div>
    </div>
    <div class="card shadow-lg rounded-lg bg-white p-4">
        <h5 class="text-2xl font-semibold text-gray-800 mb-6 text-left">Sectoral Indices Trends - Daily</h5>

        <div class="overflow-x-auto"> <!-- Enables horizontal scrolling -->
            <table class="min-w-full table-auto border-collapse text-sm text-left">
                <thead>
                    <tr class="bg-gray-800">
                        <th class="py-3 px-4 font-medium text-gray-100 border border-gray-300 whitespace-nowrap">Index</th>
                        <th class="py-3 px-4 font-medium text-gray-100 border border-gray-300 whitespace-nowrap">10 EMA</th>
                        <th class="py-3 px-4 font-medium text-gray-100 border border-gray-300 whitespace-nowrap">20 EMA</th>
                        <th class="py-3 px-4 font-medium text-gray-100 border border-gray-300 whitespace-nowrap">30 EMA</th>
                        <th class="py-3 px-4 font-medium text-gray-100 border border-gray-300 whitespace-nowrap">50 EMA</th>
                        <th class="py-3 px-4 font-medium text-gray-100 border border-gray-300 whitespace-nowrap">100 EMA</th>
                        <th class="py-3 px-4 font-medium text-gray-100 border border-gray-300 whitespace-nowrap">200 EMA</th>
                    </tr>
                </thead>
                <tbody>
                    {% for index in sector_data_table %}
                    <tr class="hover:bg-gray-50 transition-all duration-300">
                        <td class="py-3 px-4 border border-gray-300 font-medium text-gray-700">{{ index.name }}</td>
                        <td class="py-3 px-4 border border-gray-300 font-bold {% if index.ema_10 > 0 %}text-green-600{% else %}text-red-600{% endif %}">{{ index.ema_10 }} &#8593;</td>
                        <td class="py-3 px-4 border border-gray-300 font-bold {% if index.ema_20 > 0 %}text-green-600{% else %}text-red-600{% endif %}">{{ index.ema_20 }} &#8595;</td>
                        <td class="py-3 px-4 border border-gray-300 font-bold {% if index.ema_30 > 0 %}text-green-600{% else %}text-red-600{% endif %}">{{ index.ema_30 }} &#8593;</td>
                        <td class="py-3 px-4 border border-gray-300 font-bold {% if index.ema_50 > 0 %}text-green-600{% else %}text-red-600{% endif %}">{{ index.ema_50 }} &#8593;</td>
                        <td class="py-3 px-4 border border-gray-300 font-bold {% if index.ema_100 > 0 %}text-green-600{% else %}text-red-600{% endif %}">{{ index.ema_100 }} &#8593;</td>
                        <td class="py-3 px-4 border border-gray-300 font-bold {% if index.ema_200 > 0 %}text-green-600{% else %}text-red-600{% endif %}">{{ index.ema_200 }} &#8595;</td>
                    </tr>
                    {% endfor %}
                </tbody>                
            </table>
        </div>
    </div>
{% endblock %}
