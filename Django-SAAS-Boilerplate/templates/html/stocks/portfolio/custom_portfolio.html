{% extends 'stocks/portfolio/base.html' %}

{% block title %}Custom Portfolio{% endblock %}

{% block content %}
    <header class="text-center my-8">
        <h1 class="text-3xl font-bold text-gray-800">{{ username }}'s Portfolio</h1>
    </header>

    {% if msg %}
    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-6" role="alert">
        <p>{{ msg }}</p>
    </div>
    {% endif %}

    <section class="mb-10">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-semibold text-gray-700">Portfolio Summary</h2>
            <!-- Button to Open Modal -->
            <div>
                <button 
                id="open-modal-btn" 
                class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                Add Stock to Portfolio
            </button>
            <button id="open-sell-modal-btn" class="bg-green-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                Sell Stocks
            </button>            
            </div>
        </div>

        <p class="mt-4 text-gray-700 font-semibold text-right text-lg">Total Invested Capital: {{ total_invested_capital }}</p>

        <table class="min-w-full bg-white shadow-md rounded-lg">
            <thead>
                <tr class="bg-gray-800 text-white text-sm leading-normal">
                    <th class="py-3 px-6 text-left">Stock</th>
                    <th class="py-3 px-6 text-left">Last Purchased Date</th>
                    <th class="py-3 px-6 text-left">Quantity</th>
                    <th class="py-3 px-6 text-left">Average Purchase Price</th>
                    <th class="py-3 px-6 text-left">Total Value</th>
                </tr>
            </thead>
            <tbody class="text-gray-600 text-sm font-light">
                {% for item in portfolio_data %}
                <tr class="border-b border-gray-200 hover:bg-gray-100">
                    <td class="py-3 px-6">{{ item.stock.name }}</td>
                    <td class="py-3 px-6">{{ item.last_purchased_date }}</td>
                    <td class="py-3 px-6">{{ item.quantity }}</td>
                    <td class="py-3 px-6">{{ item.average_purchase_price }}</td>
                    <td class="py-3 px-6">{{ item.total_value }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="py-3 px-6 text-center text-gray-500">No portfolio data available.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </section>

    <section>
        <h2 class="text-2xl font-semibold text-gray-700 mb-4">Sell Transactions</h2>
        <table class="min-w-full bg-white shadow-md rounded-lg">
            <thead>
                <tr class="bg-gray-800 text-white text-sm leading-normal">
                    <th class="py-3 px-6 text-left">Stock</th>
                    <th class="py-3 px-6 text-left">Quantity</th>
                    <th class="py-3 px-6 text-left">Total Price</th>
                    <th class="py-3 px-6 text-left">Sell Date</th>
                    <th class="py-3 px-6 text-left">Profit/Loss</th>
                </tr>
            </thead>
            <tbody class="text-gray-600 text-sm font-light">
                {% for item in sell_data %}
                <tr class="border-b border-gray-200 hover:bg-gray-100">
                    <td class="py-3 px-6">{{ item.stock.name }}</td>
                    <td class="py-3 px-6">{{ item.quantity }}</td>
                    <td class="py-3 px-6">{{ item.total_price }}</td>
                    <td class="py-3 px-6">{{ item.last_sell_date }}</td>
                    <td class="py-3 px-6">
                        {% if item.is_profit %}
                        <span class="text-green-500 font-bold">Profit: {{ item.profit_or_loss }}</span>
                        {% else %}
                        <span class="text-red-500 font-bold">Loss: {{ item.profit_or_loss }}</span>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="py-3 px-6 text-center text-gray-500">No sell transactions recorded.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </section>

        <!-- Modal -->
        <div 
            id="add-stock-modal" 
            class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
            <div class="bg-white w-full max-w-lg p-8 rounded-lg shadow-lg">
                <h3 class="text-xl font-semibold mb-6">Add Stock to Portfolio</h3>
                <form method="POST" action="{% url 'custom_portfolio' %}" class="space-y-4" id="add-form">
                    {% csrf_token %}
                    <input type="hidden" name="add_stocks" value="1">
                    <input type="hidden" name="stock_id" id="stock_id">
                
                    <div class="relative">
                        <label for="stock-search" class="block text-gray-700 text-sm font-bold mb-2">Stock:</label>
                        <input 
                            type="text" 
                            id="stock-search" 
                            class="w-full px-3 py-2 border rounded mb-2" 
                            placeholder="Search for stock..."
                            autocomplete="off"
                            required
                        >
                        <div 
                            id="stock-dropdown" 
                            class="absolute w-full bg-white border rounded mt-1 hidden z-10 shadow-lg max-h-60 overflow-auto">
                            <ul id="stock-list" class="list-none p-0 m-0">
                                {% for stock in stocks %}
                                <li class="py-2 px-3 cursor-pointer hover:bg-gray-200" data-id="{{ stock.id }}" data-name="{{ stock.name }}">
                                    {{ stock.name }}
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                
                    <div>
                        <label for="last_purchased_date" class="block text-gray-700 text-sm font-bold mb-2">Purchase Date:</label>
                        <input type="date" name="last_purchased_date" id="last_purchased_date" required class="w-full px-3 py-2 border rounded">
                    </div>
                
                    <div>
                        <label for="quantity" class="block text-gray-700 text-sm font-bold mb-2">Quantity:</label>
                        <input type="number" name="quantity" id="quantity" min="1" required class="w-full px-3 py-2 border rounded">
                    </div>
                
                    <div>
                        <label for="price_per_share" class="block text-gray-700 text-sm font-bold mb-2">Average Purchase Price:</label>
                        <input type="number" name="price_per_share" id="price_per_share" step="0.01" required class="w-full px-3 py-2 border rounded">
                    </div>
                
                    <div class="flex justify-end space-x-4">
                        <button 
                            type="button" 
                            id="cancel-modal-btn" 
                            class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">
                            Cancel
                        </button>
                        <button 
                            type="submit" 
                            class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                            Submit
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <div id="sell-stock-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
            <div class="bg-white w-full max-w-lg p-8 rounded-lg shadow-lg">
                <h3 class="text-xl font-semibold mb-6">Add Stock to Portfolio</h3>
                <form method="POST" action="{% url 'custom_portfolio' %}" class="space-y-4" id="sell-form">
                    {% csrf_token %}
                    {% comment %} <input type="hidden" name="add_stocks" value="1">
                    <input type="hidden" name="stock_id" id="stock_id">
                
                    <div class="relative">
                        <label for="stock-search" class="block text-gray-700 text-sm font-bold mb-2">Stock:</label>
                        <input 
                            type="text" 
                            id="stock-search" 
                            class="w-full px-3 py-2 border rounded mb-2" 
                            placeholder="Search for stock..."
                            autocomplete="off"
                            required
                        >
                        <div 
                            id="stock-dropdown" 
                            class="absolute w-full bg-white border rounded mt-1 hidden z-10 shadow-lg max-h-60 overflow-auto">
                            <ul id="stock-list" class="list-none p-0 m-0">
                                {% for stock in stocks %}
                                <li class="py-2 px-3 cursor-pointer hover:bg-gray-200" data-id="{{ stock.id }}" data-name="{{ stock.name }}">
                                    {{ stock.name }}
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                
                    <div>
                        <label for="last_purchased_date" class="block text-gray-700 text-sm font-bold mb-2">Purchase Date:</label>
                        <input type="date" name="last_purchased_date" id="last_purchased_date" required class="w-full px-3 py-2 border rounded">
                    </div>
                
                    <div>
                        <label for="quantity" class="block text-gray-700 text-sm font-bold mb-2">Quantity:</label>
                        <input type="number" name="quantity" id="quantity" min="1" required class="w-full px-3 py-2 border rounded">
                    </div>
                
                    <div>
                        <label for="price_per_share" class="block text-gray-700 text-sm font-bold mb-2">Average Purchase Price:</label>
                        <input type="number" name="price_per_share" id="price_per_share" step="0.01" required class="w-full px-3 py-2 border rounded">
                    </div>
                 {% endcomment %}
                    <div class="flex justify-end space-x-4">
                        <button 
                            type="button" 
                            id="cancel-sell-modal-btn" 
                            class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">
                            Cancel
                        </button>
                        <button 
                            type="submit" 
                            class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                            Submit
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <script>

            
            // Modal toggle for selling a stock
            const openSellModalBtn = document.getElementById('open-sell-modal-btn');
            const sellStockModal = document.getElementById('sell-stock-modal');
            const cancelSellModalBtn = document.getElementById('cancel-sell-modal-btn');
        
            openSellModalBtn.addEventListener('click', (e) => {
                console.log(e.target.tagName)
                sellStockModal.classList.remove('hidden');
            });                        

            cancelSellModalBtn.addEventListener('click', () => {
                sellStockModal.classList.add('hidden');
            });

            const searchInput = document.getElementById('stock-search');
            const dropdown = document.getElementById('stock-dropdown');
            const stockList = document.getElementById('stock-list');
            const stockIdInput = document.getElementById('stock_id');
            
            // Handle input event for searching stocks
            searchInput.addEventListener('input', function() {
                const filter = searchInput.value.toUpperCase();
                const items = stockList.getElementsByTagName('li');
                let found = false;
        
                if (filter.length > 0) {
                    dropdown.classList.remove('hidden');
                } else {
                    dropdown.classList.add('hidden');
                }
        
                for (let i = 0; i < items.length; i++) {
                    const txtValue = items[i].textContent || items[i].innerText;
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        items[i].style.display = ""; // Show matched option
                        found = true;
                    } else {
                        items[i].style.display = "none"; // Hide non-matching option
                    }
                }
        
                // Show "No results found" if no matching items
                const noResultOption = stockList.querySelector('li.cursor-not-allowed');
                if (!found && filter.length > 0) {
                    if (!noResultOption) {
                        const noResult = document.createElement('li');
                        noResult.classList.add('py-2', 'px-3', 'text-gray-500', 'cursor-not-allowed');
                        noResult.textContent = "No results found";
                        stockList.appendChild(noResult);
                    }
                } else {
                    if (noResultOption) {
                        stockList.removeChild(noResultOption);
                    }
                }
            });
         
            // Handle stock selection from the dropdown
            stockList.addEventListener('click', function(event) {
                if (event.target.tagName === 'LI') {
                    const stockId = event.target.getAttribute('data-id');
                    const stockName = event.target.getAttribute('data-name');
                    searchInput.value = stockName;
                    stockIdInput.value = stockId;
                    dropdown.classList.add('hidden');
                }
            });
        
            // Close the dropdown when clicking outside of it
            document.addEventListener('click', function(event) {
                if (!dropdown.contains(event.target) && event.target !== searchInput) {
                    dropdown.classList.add('hidden');
                }
            });
        
            // Modal toggle for adding a stock
            const openModalBtn = document.getElementById('open-modal-btn');
            const addStockModal = document.getElementById('add-stock-modal');
            const cancelModalBtn = document.getElementById('cancel-modal-btn');
        
            openModalBtn.addEventListener('click', () => {
                addStockModal.classList.remove('hidden');
            });
        
            cancelModalBtn.addEventListener('click', () => {
                addStockModal.classList.add('hidden');
            });
        
            // Form submission check for stock selection
            document.querySelector('add-form').addEventListener('submit', function (event) {
                if (!stockIdInput.value) {
                    event.preventDefault();
                    alert('Please select a valid stock from the dropdown.');
                }
            });
        </script>        
{% endblock %}
