{% extends 'blog/base.html' %} 

{% block content %}

  
  <!-- Add this in the <head> section of your HTML -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">

  
  <div class="fixed top-0 right-0 h-full w-[5%]  backdrop-blur-md flex flex-col items-center justify-center space-y-7">
    <a href="https://www.facebook.com" target="_blank" class="bg-blue-600 text-white w-10 h-10 flex items-center justify-center rounded-full hover:bg-blue-700">
        <i class="fab fa-facebook-f"></i>
    </a>
    <a href="https://www.twitter.com" target="_blank" class="bg-blue-400 text-white w-10 h-10 flex items-center justify-center rounded-full hover:bg-blue-500">
        <i class="fab fa-twitter"></i>
    </a>
    <a href="https://www.instagram.com" target="_blank" class="bg-pink-500 text-white w-10 h-10 flex items-center justify-center rounded-full hover:bg-pink-600">
        <i class="fab fa-instagram"></i>
    </a>
    <a href="https://www.linkedin.com" target="_blank" class="bg-blue-800 text-white w-10 h-10 flex items-center justify-center rounded-full hover:bg-blue-900">
        <i class="fab fa-linkedin-in"></i>
    </a>
</div>

<!-- Blog Category Buttons -->
<div class="flex justify-center space-x-6 mt-8 mb-8">
  <a href="{% url 'blog:list_blogs' %}" 
     class="flex items-center px-8 py-4 bg-[#7C3AED] text-white rounded-xl shadow-lg hover:bg-[#6D28D9] hover:shadow-xl transition-all duration-300 transform hover:scale-105">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="currentColor" viewBox="0 0 24 24">
          <path d="M10 8.64L15.27 12 10 15.36V8.64M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/>
      </svg>
      Videos
  </a>

  <a href="{% url 'blog:view_blogs' %}" 
     class="flex items-center px-8 py-4 bg-[#0D9488] text-white rounded-xl shadow-lg hover:bg-[#0F766E] hover:shadow-xl transition-all duration-300 transform hover:scale-105">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="currentColor" viewBox="0 0 24 24">
          <path d="M5 4v16h14V4H5zm2 2h10v2H7V6zm0 4h10v2H7v-2zm0 4h10v2H7v-2z"/>
      </svg> 
      Blogs
  </a>
</div>



<div class="flex flex-col md:flex-row md:justify-between items-center mt-[10%] py-5 bg-[#1F2937] px-3 rounded-lg shadow-lg w-[90%] mx-auto">
    
  <!-- Desktop Filter Buttons (Hidden on Mobile) -->
  <div class="hidden md:flex space-x-4">
      <a href="?filter=latest" 
         class="px-6 py-2 rounded-xl {% if filter_type == 'latest' %}bg-blue-600 text-white{% else %}bg-gray-600 text-white hover:bg-blue-700{% endif %}">
          Latest
      </a>
      
      <a href="?filter=oldest" 
         class="px-4 py-2 rounded-xl {% if filter_type == 'oldest' %}bg-blue-600 text-white{% else %}bg-gray-600 text-white hover:bg-blue-700{% endif %}">
          Oldest
      </a>
      
      <a href="?filter=most_liked" 
         class="px-4 py-2 rounded-xl {% if filter_type == 'most_liked' %}bg-blue-600 text-white{% else %}bg-gray-600 text-white hover:bg-blue-700{% endif %}">
          Most Liked
      </a>
      
      <a href="?filter=most_commented" 
         class="px-4 py-2 rounded-xl {% if filter_type == 'most_commented' %}bg-blue-600 text-white{% else %}bg-gray-600 text-white hover:bg-blue-700{% endif %}">
          Most Commented
      </a>

      <a href="?filter=most_viewed" 
         class="px-4 py-2 rounded-xl {% if filter_type == 'most_viewed' %}bg-blue-600 text-white{% else %}bg-gray-600 text-white hover:bg-blue-700{% endif %}">
          Most Viewed
      </a>
  </div>

  <!-- Mobile Dropdown (Visible on Small Screens) -->
  <div class="md:hidden w-full mb-4">
      <select id="mobileFilter" class="w-full px-4 py-2 rounded-xl bg-gray-700 text-white border-2 border-gray-500 focus:ring-2 focus:ring-blue-500 transition duration-300">
          <option value="">Select Filter</option>
          <option value="latest" {% if filter_type == 'latest' %}selected{% endif %}>Latest</option>
          <option value="oldest" {% if filter_type == 'oldest' %}selected{% endif %}>Oldest</option>
          <option value="most_liked" {% if filter_type == 'most_liked' %}selected{% endif %}>Most Liked</option>
          <option value="most_commented" {% if filter_type == 'most_commented' %}selected{% endif %}>Most Commented</option>
          <option value="most_viewed" {% if filter_type == 'most_viewed' %}selected{% endif %}>Most Viewed</option>
      </select>
  </div>

  <!-- Search Bar -->
  <form action="{% url 'blog:search' %}" method="get" class="flex items-center space-x-3">
    <input type="text" name="q" placeholder="Search blogs..." value="{{ query }}" 
           class="px-4 py-2 rounded-xl border-2 border-gray-500 focus:outline-none focus:ring-2 focus:ring-[#6366F1] bg-[#1F2937] text-white w-64 placeholder-gray-400 transition duration-300" />
    <button type="submit" class="px-4 py-2 rounded-xl bg-[#6366F1] text-white hover:bg-[#4F46E5] transition-all duration-300 shadow-md">
        <i class="fas fa-search"></i>
    </button>
</form>
</div>





    <!-- Font Awesome Script -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>

    <div class="container mx-auto px-4 py-8 mt-0 bg-gray-200 w-[90%]">
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 xl:grid-cols-2 gap-8">
        <!-- Iterate through all blogs -->
        {% for blog in blogs %}
        <div class="bg-[#1F2937] rounded-lg shadow-lg overflow-hidden flex flex-col">
          <!-- Blog Thumbnail -->
          {% if blog.thumbnail %}
          <img src="{{ blog.thumbnail.url }}" alt="{{ blog.title }}" class="w-full h-64 object-cover">
          {% endif %}
    
      <!-- Blog Content -->
<div class="p-4">
  <!-- Blog Title -->
  <h2 class="text-xl font-semibold mb-2">
    <a 
      href="{{ blog.video_url }}" 
      class="text-blue-600 hover:underline blog-title" 
      target="_blank" 
      onclick="incrementView('{{ blog.slug }}')">
      {{ blog.title }}
    </a>
  </h2>

  <!-- YouTube Video -->
  {% if blog.youtube_video_id %}
  <div class="mb-8 mt-4">
    <iframe 
      class="w-full h-64 youtube-video"
      src="https://www.youtube.com/embed/{{ blog.youtube_video_id}}" 
      frameborder="0" 
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
      allowfullscreen 
      onclick="incrementView('{{ blog.slug }}')">
    </iframe>
  </div>
  {% endif %}

    
            <!-- Blog Description -->
            <div class="bod text-white">
              <h2 
                class="text-white text-sm mb-0 h-20 overflow-hidden font-semibold transition-all blog-description" 
                id="blog-description-{{ blog.id }}">
                {{ blog.body|safe }}
              </h2>
              <button 
                class="read-more text-blue-600 hover:underline" 
                data-blog-id="{{ blog.id }}">
                Read More
              </button>
            </div>
    
            <!-- Interaction Section -->
            <div class="flex items-center justify-between text-white text-xs mt-6 font-bold">
              <p><strong>Published on:</strong> {{ blog.datetime|date:"F j, Y" }}</p>
    
              <!-- Like, Dislike, and Comment Buttons -->
              <div class="flex space-x-3">
                <!-- Like Button -->
                <form id="like-form-{{ blog.slug }}" method="POST" action="{% url 'blog:update_like' blog.slug %}">
                  {% csrf_token %}
                  <button type="button" class="like-btn flex items-center text-white-600 hover:text-blue-800 text-xl px-0 mt-1 " data-slug="{{ blog.slug }}">
                    <i class="fas fa-thumbs-up"></i>
                  </button>
                  
                </form>
                <span  class="mt-3"id="like-count-{{ blog.slug }}">{{ blog.interaction.likes }}</span>
    
                <!-- Dislike Button -->
                <button id="dislike-btn-{{ blog.id }}" class="dislike-btn flex items-center text-white-200 hover:text-blue-800 text-xl">
                  <i class="fas fa-thumbs-down"></i>
                </button>
                <span class="mt-3"id="dislike-count-{{ blog.id }}">0</span>
    
 <!-- Comment Button -->
<button class="comment-btn flex items-center text-white-600 hover:text-blue-800 text-xl" data-slug="{{ blog.slug }}">
  <i class="fas fa-comment"></i>
</button>
<span class="mt-2.5"id="comment-count-{{ blog.slug }}">{{ blog.interaction.comments.count }}</span> <!-- Comment count -->

</div>
</div>

<!-- Hidden Comment Section -->
<div id="comment-section-{{ blog.slug }}" class="hidden mt-4 p-4 border rounded bg-gray-100">
  <!-- CSRF Token -->
  <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

  <!-- Textarea for Adding a Comment -->
  <form method="POST" action="{% url 'blog:comment_blog' blog.slug %}">
    {% csrf_token %}
    <textarea name="comment_text" id="comment-text-{{ blog.slug }}" placeholder="Write your comment..." class="w-full p-2 border rounded-md">
      {% if existing_comment %}
        {{ existing_comment.text }}
      {% endif %}
    </textarea>
    <button type="submit" class="submit-comment mt-2 bg-blue-600 text-white p-2 rounded">Submit Comment</button>
  </form>

  <!-- List of Existing Comments -->
  <div id="comments-list-{{ blog.slug }}" class="mt-4">
    {% for comment in blog.interaction.comments.all %}
    <div class="p-2 border-b">
      <p class="font-bold">{{ comment.user.username }}</p>
      <p>{{ comment.text }}</p>
      <p class="text-gray-500 text-sm">{{ comment.created_at|date:"F j, Y H:i" }}</p>
    </div>
    {% endfor %}
  </div>
</div>




          </div>
        </div>
      
    
        <!-- Show a message if no blogs are available -->
        {% empty %}
        <p class="text-center text-white">No blogs available.</p>
        {% endfor %}
      </div>
    </div>
    
      
    <div class="flex justify-center mt-6">
      <div class="inline-flex space-x-2 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg">
          {% if blogs.has_previous %}
              <a href="?page=1&filter={{ filter_type }}" 
                 class="px-3 py-2 rounded-lg bg-gray-700 hover:bg-blue-600 transition duration-200">
                  &laquo; First
              </a>
              <a href="?page={{ blogs.previous_page_number }}&filter={{ filter_type }}" 
                 class="px-3 py-2 rounded-lg bg-gray-700 hover:bg-blue-600 transition duration-200">
                  Previous
              </a>
          {% else %}
              <span class="px-3 py-2 text-gray-500 cursor-not-allowed"> &laquo; First </span>
              <span class="px-3 py-2 text-gray-500 cursor-not-allowed"> Previous </span>
          {% endif %}
  
          <span class="px-4 py-2 rounded-lg bg-blue-600 font-semibold">
              Page {{ blogs.number }} of {{ blogs.paginator.num_pages }}
          </span>
  
          {% if blogs.has_next %}
              <a href="?page={{ blogs.next_page_number }}&filter={{ filter_type }}" 
                 class="px-3 py-2 rounded-lg bg-gray-700 hover:bg-blue-600 transition duration-200">
                  Next
              </a>
              <a href="?page={{ blogs.paginator.num_pages }}&filter={{ filter_type }}" 
                 class="px-3 py-2 rounded-lg bg-gray-700 hover:bg-blue-600 transition duration-200">
                  Last &raquo;
              </a>
          {% else %}
              <span class="px-3 py-2 text-gray-500 cursor-not-allowed"> Next </span>
              <span class="px-3 py-2 text-gray-500 cursor-not-allowed"> Last &raquo; </span>
          {% endif %}
      </div>
  </div>
  
      </div>
    
   
    <script>
  // Select all "Read More" buttons
  const readMoreButtons = document.querySelectorAll('.read-more');

  readMoreButtons.forEach((button) => {
    button.addEventListener('click', function () {
      // Get the blog ID from the button's data attribute
      const blogId = this.getAttribute('data-blog-id');
      
      // Find the corresponding description element
      const blogDescription = document.getElementById(`blog-description-${blogId}`);

      // Toggle classes for expanding/collapsing
      blogDescription.classList.toggle('h-20');
      blogDescription.classList.toggle('overflow-hidden');

      // Update button text
      if (blogDescription.classList.contains('h-20')) {
        this.textContent = 'Read More';
      } else {
        this.textContent = 'Read Less';
      }
    });
  });
</script>


<script>
  document.querySelectorAll('.like-btn').forEach((button) => {
    button.addEventListener('click', function (e) {
      e.preventDefault(); // Prevent default behavior
  
      const slug = this.dataset.slug; // Get the blog's slug
      const likeCountElement = document.querySelector(`#like-count-${slug}`); // Like count display
      const form = document.querySelector(`#like-form-${slug}`); // Form element
  
      // Get the current like count
      let currentLikes = parseInt(likeCountElement.textContent) || 0;
  
      // Send an AJAX request to toggle like
      fetch(form.action, {
        method: 'POST',
        headers: {
          'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value,
          'Content-Type': 'application/json',
        },
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.status === 'liked') {
            // If liked, increment the like count
            likeCountElement.textContent = currentLikes + 1;
          } else if (data.status === 'unliked') {
            // If unliked, decrement the like count
            likeCountElement.textContent = currentLikes - 1;
          }
        })
        .catch((error) => console.error('Error:', error));
    });
  });
  
  
  
document.querySelectorAll('.comment-btn').forEach((button) => {
  button.addEventListener('click', function () {
    const slug = this.dataset.slug;
    const commentSection = document.querySelector(`#comment-section-${slug}`);
    // Toggle visibility
    if (commentSection.classList.contains('hidden')) {
      commentSection.classList.remove('hidden');
    } else {
      commentSection.classList.add('hidden');
    }
  });
});

document.querySelectorAll('.submit-comment').forEach((button) => {
  button.addEventListener('click', function () {
    const slug = this.dataset.slug;
    const commentTextElement = document.querySelector(`#comment-text-${slug}`);
    const commentsList = document.querySelector(`#comments-list-${slug}`);
    const commentText = commentTextElement.value.trim();

    if (!commentText) {
      alert('Comment cannot be empty.');
      return;
    }

    fetch(`/blog/add_comment/${slug}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ comment_text: commentText }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.status === 'success') {
          // Append the new comment to the list
          const newComment = document.createElement('div');
          newComment.classList.add('p-2', 'border-b');
          newComment.innerHTML = `
            <p class="font-bold">${data.user}</p>
            <p>${data.comment_text}</p>
            <p class="text-gray-500 text-sm">${data.created_at}</p>
          `;
          commentsList.prepend(newComment);

          // Clear the textarea
          commentTextElement.value = '';
        } else {
          alert(data.error || 'Something went wrong.');
        }
      })
      .catch((error) => console.error('Error:', error));
  });
});

  
  
  
</script>
<script>
  // Handle the comment submission
document.querySelectorAll('.submit-comment').forEach(button => {
  button.addEventListener('click', function() {
      const blogSlug = this.getAttribute('data-slug');
      const commentText = document.querySelector(`#comment-text-${blogSlug}`).value;
      
      // Send the comment via AJAX
      fetch(`/comment_blog/${blogSlug}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: `comment_text=${commentText}`
    })
    
      .then(response => response.json())
      .then(data => {
          if (data.status === 'success') {
              // Add the new comment to the list
              const commentsList = document.querySelector(`#comments-list-${blogSlug}`);
              commentsList.innerHTML += `
                  <div class="p-2 border-b">
                      <p class="font-bold">${data.user}</p>
                      <p>${commentText}</p>
                      <p class="text-gray-500 text-sm">${data.created_at}</p>
                  </div>
              `;

              // Update the comment count
              document.querySelector(`#comment-count-${blogSlug}`).textContent = data.comment_count;
          } else {
              alert(data.message); // Show error message
          }
      })
      .catch(error => console.error('Error:', error));
  });
});

</script>

<script>
  // Function to increment the view count
  function incrementView(slug) {
    fetch(`/blog/increment_view/${slug}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/json'
      }
    }).then(response => {
      if (response.ok) {
        console.log('View count updated');
      } else {
        console.error('Failed to update view count');
      }
    });
  }
</script>

<script>
  document.getElementById("mobileFilter").addEventListener("change", function() {
      var selectedValue = this.value;
      if (selectedValue) {
          window.location.href = "?filter=" + selectedValue;
      }
  });
</script>
    
{% endblock %}
